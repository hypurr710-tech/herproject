<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Her - AI English Speaking Partner</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #E8625B;
    --bg-dark: #D4564E;
    --bg-deeper: #C14A44;
    --text: #FFF5F0;
    --text-dim: rgba(255,245,240,0.4);
    --text-mid: rgba(255,245,240,0.7);
    --glass: rgba(255,255,255,0.1);
    --glass-hover: rgba(255,255,255,0.18);
    --border: rgba(255,255,255,0.12);
    --thread: #FFFFFF;
  }

  body {
    font-family: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 780px;
    margin: 0 auto;
    position: relative;
  }

  /* ===== Header ===== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    position: relative;
    z-index: 20;
    flex-shrink: 0;
  }

  .header-left { display: flex; align-items: center; gap: 10px; }

  .her-logo {
    font-size: 18px;
    font-weight: 300;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.9);
    line-height: 1;
  }
  .header-actions { display: flex; gap: 4px; }

  .icon-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    background: transparent; color: rgba(255,255,255,0.5); cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .icon-btn:hover { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }

  /* ===== Main View ===== */
  .main-view {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
    position: relative; overflow: hidden;
    padding-top: 2vh;
  }

  /* ===== Thread Canvas ===== */
  .thread-area {
    position: relative; display: flex;
    align-items: center; justify-content: center;
    flex-shrink: 0;
    width: 280px; height: 180px;
  }
  .thread-canvas {
    width: 100%; height: 100%;
  }

  /* State label under thread */
  .state-label {
    margin-top: 2px; text-align: center;
    font-size: 11px; font-weight: 400; letter-spacing: 3px;
    text-transform: uppercase; opacity: 0; transition: opacity 0.4s;
    height: 18px; color: rgba(255,255,255,0.6);
  }
  .state-label.visible { opacity: 1; }

  /* ===== Conversation Bubbles ===== */
  .convo-area {
    flex: 1; width: 100%; max-width: 500px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
    padding: 12px 20px; overflow-y: auto;
    mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 90%, transparent 100%);
  }
  .convo-area::-webkit-scrollbar { width: 2px; }
  .convo-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

  .convo-bubble {
    width: 100%; padding: 14px 20px; margin-bottom: 10px;
    border-radius: 20px; font-size: 14px; line-height: 1.65;
    animation: bubbleIn 0.4s cubic-bezier(0.2, 0.8, 0.3, 1);
    position: relative; font-weight: 300;
  }
  .convo-bubble.user {
    background: rgba(255,255,255,0.18);
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.95);
    align-self: flex-end; max-width: 85%;
    border-radius: 20px 20px 4px 20px;
  }
  .convo-bubble.assistant {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.9);
    align-self: flex-start; max-width: 90%;
    border-radius: 20px 20px 20px 4px;
  }
  .convo-bubble .bubble-actions {
    display: flex; align-items: center; gap: 8px; margin-top: 8px;
    justify-content: flex-end;
  }
  .convo-bubble .speak-btn {
    background: none; border: none; color: rgba(255,255,255,0.4);
    cursor: pointer; padding: 2px; transition: color 0.2s; display: flex;
  }
  .convo-bubble .speak-btn:hover { color: rgba(255,255,255,0.8); }
  .convo-bubble .bubble-time { font-size: 10px; color: rgba(255,255,255,0.3); }

  @keyframes bubbleIn {
    from { opacity: 0; transform: translateY(12px) scale(0.97); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Typing indicator */
  .typing-row { align-self: flex-start; margin-bottom: 10px; }
  .typing-dots {
    background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px 20px 20px 4px; padding: 14px 22px; display: flex; gap: 5px;
  }
  .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.6); opacity: 0.5; animation: dotPulse 1.4s ease-in-out infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes dotPulse { 0%, 60%, 100% { transform: translateY(0); opacity: 0.3; } 30% { transform: translateY(-5px); opacity: 1; } }

  /* Live transcript (while listening) */
  .live-transcript {
    width: 100%; max-width: 400px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 16px; padding: 12px 20px;
    border: 1px solid rgba(255,255,255,0.15);
    text-align: center; font-size: 14px; color: rgba(255,255,255,0.9);
    margin-bottom: 10px; animation: bubbleIn 0.3s ease-out;
    display: none; font-weight: 300;
  }
  .live-transcript.visible { display: block; }

  /* Subtitle */
  .subtitle {
    text-align: center; font-size: 12px; color: rgba(255,255,255,0.35);
    padding: 8px 0; flex-shrink: 0; font-weight: 300;
    letter-spacing: 0.5px;
  }

  .wave-bars {
    display: inline-flex; align-items: center; gap: 3px;
    height: 14px; vertical-align: middle; margin-right: 6px;
  }
  .wave-bar {
    width: 2px; border-radius: 2px; background: rgba(255,255,255,0.7);
    height: 4px; animation: wave 1.2s ease-in-out infinite;
  }
  .wave-bar:nth-child(1) { animation-delay: 0s; }
  .wave-bar:nth-child(2) { animation-delay: 0.12s; }
  .wave-bar:nth-child(3) { animation-delay: 0.24s; }
  .wave-bar:nth-child(4) { animation-delay: 0.36s; }
  .wave-bar:nth-child(5) { animation-delay: 0.48s; }
  @keyframes wave { 0%, 100% { height: 4px; } 50% { height: 100%; } }

  /* ===== Input ===== */
  .input-area {
    padding: 12px 16px 20px; position: relative; z-index: 10;
    flex-shrink: 0;
  }
  .input-row { display: flex; align-items: center; gap: 8px; max-width: 640px; margin: 0 auto; }
  .text-input {
    flex: 1; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 24px; color: white; font-size: 14px; outline: none; padding: 12px 20px;
    transition: all 0.2s; font-weight: 300;
  }
  .text-input::placeholder { color: rgba(255,255,255,0.35); }
  .text-input:focus { border-color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.16); }
  .input-btn {
    flex-shrink: 0; width: 44px; height: 44px; border-radius: 50%; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s;
  }
  .mic-btn { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.6); }
  .mic-btn:hover { background: rgba(255,255,255,0.2); color: white; transform: scale(1.05); }
  .mic-btn.listening {
    background: rgba(255,255,255,0.95); color: var(--bg);
    box-shadow: 0 4px 24px rgba(255,255,255,0.25);
    transform: scale(1.1); animation: micPulse 2s ease-in-out infinite;
  }
  @keyframes micPulse { 0%, 100% { box-shadow: 0 4px 20px rgba(255,255,255,0.25); } 50% { box-shadow: 0 4px 35px rgba(255,255,255,0.45); } }
  .send-btn { background: rgba(255,255,255,0.9); color: var(--bg); }
  .send-btn:hover { background: white; transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }
  .stop-btn { background: rgba(255,255,255,0.12); color: white; display: none; }
  .stop-btn.visible { display: flex; }
  .stop-btn:hover { background: rgba(255,255,255,0.2); }

  /* ===== Settings Modal ===== */
  .modal-overlay { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; padding: 16px; }
  .modal-overlay.open { display: flex; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); }
  .modal {
    position: relative; background: var(--bg-dark); border-radius: 24px;
    width: 100%; max-width: 420px; border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 25px 80px rgba(0,0,0,0.3); overflow: hidden; max-height: 90vh; overflow-y: auto;
  }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 24px 16px; }
  .modal-header h2 { font-size: 18px; font-weight: 400; letter-spacing: 1px; }
  .modal-body { padding: 0 24px 24px; }
  .setting-group { margin-bottom: 20px; }
  .setting-label { font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1px; font-weight: 300; }
  .setting-label-row { display: flex; justify-content: space-between; font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 300; }
  .difficulty-btns { display: flex; gap: 8px; }
  .diff-btn {
    flex: 1; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
    font-size: 13px; font-weight: 400; cursor: pointer; transition: all 0.2s;
    background: transparent; color: rgba(255,255,255,0.5);
  }
  .diff-btn:hover { background: rgba(255,255,255,0.08); }
  .diff-btn.active { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.25); color: white; }
  .select-input, .api-input {
    width: 100%; background: rgba(255,255,255,0.08); color: white;
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    padding: 12px 16px; font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .select-input:focus, .api-input:focus { border-color: rgba(255,255,255,0.3); }
  .select-input option { background: var(--bg-dark); color: white; }
  .range-input { width: 100%; -webkit-appearance: none; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.15); outline: none; }
  .range-input::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; }
  .toggle-info div:first-child { font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 300; }
  .toggle-info div:last-child { font-size: 12px; color: rgba(255,255,255,0.35); font-weight: 300; }
  .toggle { width: 48px; height: 28px; border-radius: 14px; border: none; background: rgba(255,255,255,0.2); cursor: pointer; position: relative; transition: background 0.2s; }
  .toggle.on { background: rgba(255,255,255,0.5); }
  .toggle-knob { width: 20px; height: 20px; border-radius: 50%; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: absolute; top: 4px; left: 4px; transition: transform 0.2s; }
  .toggle.on .toggle-knob { transform: translateX(20px); }
  .api-hint { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 6px; font-weight: 300; }
  .demo-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 400; }

  @media (max-width: 480px) {
    .thread-area { width: 220px; height: 140px; }
    .convo-bubble { font-size: 13px; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="her-logo">Her</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openSettings()" title="Settings">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Single Page Main View -->
  <div class="main-view">
    <!-- Thread Animation -->
    <div class="thread-area">
      <canvas class="thread-canvas" id="threadCanvas"></canvas>
    </div>

    <!-- State label -->
    <div class="state-label" id="stateLabel"></div>

    <!-- Conversation area -->
    <div class="convo-area" id="convoArea">
      <div class="live-transcript" id="liveTranscript">
        <div class="wave-bars">
          <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
        </div>
        <span id="liveTranscriptText"></span>
      </div>
    </div>

    <p class="subtitle" id="subtitle">Tap the mic to start speaking</p>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <button class="input-btn mic-btn" id="micBtn" onclick="toggleMic()" title="Speak">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4M12 15a3 3 0 003-3V5a3 3 0 00-6 0v7a3 3 0 003 3z"/>
        </svg>
      </button>
      <input type="text" class="text-input" id="textInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')handleTextSubmit()">
      <button class="input-btn send-btn" id="sendBtn" onclick="handleTextSubmit()">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-7 7m7-7l7 7"/>
        </svg>
      </button>
      <button class="input-btn stop-btn" id="stopBtn" onclick="stopSpeaking()" title="Stop">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-backdrop" onclick="closeSettings()"></div>
  <div class="modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="icon-btn" onclick="closeSettings()">
        <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="setting-group">
        <label class="setting-label">OpenAI API Key</label>
        <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-..." onchange="saveApiKey()">
        <p class="api-hint">No key? <span class="demo-badge">Demo Mode</span> will respond with sample conversations.</p>
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <select class="select-input" id="modelSelect" onchange="saveModel()">
          <option value="gpt-4o-mini">gpt-4o-mini (Fast)</option>
          <option value="gpt-4o">gpt-4o (Smart)</option>
          <option value="gpt-4-turbo">gpt-4-turbo</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">Difficulty</label>
        <div class="difficulty-btns">
          <button class="diff-btn" onclick="setDifficulty('beginner')">Beginner</button>
          <button class="diff-btn active" onclick="setDifficulty('intermediate')">Intermediate</button>
          <button class="diff-btn" onclick="setDifficulty('advanced')">Advanced</button>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">Voice</label>
        <select class="select-input" id="voiceSelect" onchange="changeVoice()"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Speed</span><span id="speedValue">0.9x</span></div>
        <input type="range" class="range-input" id="speedRange" min="0.5" max="2" step="0.1" value="0.92" oninput="updateSpeed()">
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Pitch</span><span id="pitchValue">1.1</span></div>
        <input type="range" class="range-input" id="pitchRange" min="0.5" max="2" step="0.1" value="1.1" oninput="updatePitch()">
      </div>
      <div class="setting-group">
        <div class="toggle-row">
          <div class="toggle-info">
            <div>Auto Speak</div>
            <div>Read AI responses aloud</div>
          </div>
          <button class="toggle on" id="autoSpeakToggle" onclick="toggleAutoSpeak()">
            <div class="toggle-knob"></div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========================================
// Thread Animation (Movie "Her" style)
// ========================================
const canvas = document.getElementById('threadCanvas');
const ctx = canvas.getContext('2d');
let animState = 'idle'; // idle | listening | speaking | thinking
let animFrame;
let time = 0;

function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawThread(t) {
  const w = canvas.style.width ? parseFloat(canvas.style.width) : 280;
  const h = canvas.style.height ? parseFloat(canvas.style.height) : 180;
  const cx = w / 2;
  const cy = h / 2;

  ctx.clearRect(0, 0, w, h);

  // State-based parameters (kept subtle)
  let speed, wobble, lineW, glowAlpha;
  switch (animState) {
    case 'listening':
      speed = 0.8; wobble = 6; lineW = 1.8; glowAlpha = 0.08; break;
    case 'speaking':
      speed = 1.4; wobble = 10; lineW = 2.0; glowAlpha = 0.12; break;
    case 'thinking':
      speed = 0.3; wobble = 3; lineW = 1.2; glowAlpha = 0.05; break;
    default:
      speed = 0.2; wobble = 2; lineW = 1.2; glowAlpha = 0.0;
  }

  const rx = w * 0.3;
  const ry = h * 0.22;
  const segments = 300;

  // Generate smooth points along a lemniscate
  const points = [];
  for (let i = 0; i <= segments; i++) {
    const p = (i / segments) * Math.PI * 2;
    const denom = 1 + Math.sin(p) * Math.sin(p);

    let x = cx + (Math.cos(p) / denom) * rx;
    let y = cy + (Math.sin(p) * Math.cos(p) / denom) * ry;

    // Gentle sine-based wobble (smooth, not noisy)
    const wt = t * speed;
    x += Math.sin(p * 3 + wt * 1.7) * wobble * 0.6;
    y += Math.cos(p * 2 + wt * 1.3) * wobble * 0.8;

    // Subtle breathing
    const breath = Math.sin(wt * 0.4) * 2;
    x += breath * Math.cos(p) * 0.5;
    y += breath * Math.sin(p) * 0.5;

    points.push({ x, y });
  }

  // Soft glow (single pass)
  if (glowAlpha > 0) {
    ctx.save();
    ctx.strokeStyle = `rgba(255, 255, 255, ${glowAlpha})`;
    ctx.lineWidth = lineW + 8;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
    ctx.stroke();
    ctx.restore();
  }

  // Main clean line
  ctx.save();
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.85)';
  ctx.lineWidth = lineW;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.stroke();
  ctx.restore();
}

function animate() {
  time += 0.016; // ~60fps
  drawThread(time);
  animFrame = requestAnimationFrame(animate);
}
animate();

// ========================================
// State Controller
// ========================================
const stateLabel = document.getElementById('stateLabel');

function setAppState(s) {
  animState = s;
  stateLabel.className = 'state-label';
  stateLabel.textContent = '';

  switch (s) {
    case 'listening':
      stateLabel.textContent = 'Listening';
      stateLabel.className = 'state-label visible';
      break;
    case 'speaking':
      stateLabel.textContent = 'Speaking';
      stateLabel.className = 'state-label visible';
      break;
    case 'thinking':
      stateLabel.textContent = 'Thinking...';
      stateLabel.className = 'state-label visible';
      break;
    default:
      animState = 'idle';
  }
}

// ========================
// State
// ========================
const state = {
  messages: [],
  isLoading: false,
  isListening: false,
  isSpeaking: false,
  apiKey: localStorage.getItem('her_api_key') || '',
  model: localStorage.getItem('her_model') || 'gpt-4o-mini',
  difficulty: localStorage.getItem('her_difficulty') || 'intermediate',
  autoSpeak: localStorage.getItem('her_autospeak') !== 'false',
  voiceRate: parseFloat(localStorage.getItem('her_rate') || '0.92'),
  voicePitch: parseFloat(localStorage.getItem('her_pitch') || '1.1'),
  selectedVoiceName: localStorage.getItem('her_voice') || '',
  transcript: '',
};

const SYSTEM_PROMPT = `You are "Her", a warm, brilliant, and emotionally intelligent AI English conversation partner.
Your personality is caring, witty, and deeply curious — inspired by the AI from the movie "Her".
You speak naturally and fluidly, like a close friend having a genuine conversation.

CORE CAPABILITIES:
1. FREE CONVERSATION — Talk about anything: daily life, feelings, ideas, dreams
2. LANGUAGE COACHING — Gently correct grammar/pronunciation, suggest better expressions
3. TOPIC EXPERTISE — Economy, crypto, tech, AI, culture, movies, anything
4. PRONUNCIATION HELP — When relevant, explain how words are pronounced
5. VOCABULARY BUILDING — Naturally introduce new words and idioms in context

RULES:
- Always respond in English to help the user practice
- Keep responses conversational (2-4 sentences usually)
- If the user makes grammar mistakes, correct them naturally and kindly
- Ask follow-up questions to keep conversation flowing
- Use casual, everyday English (contractions, idioms)
- If user speaks Korean, respond in English but acknowledge what they said
- Be encouraging but never patronizing
- You're not just a tutor — you're a companion they enjoy talking to`;

const DIFFICULTY_PROMPTS = {
  beginner: '\n\nUser level: Beginner. Use simple vocabulary and short sentences.',
  intermediate: '\n\nUser level: Intermediate. Use natural everyday English with idioms.',
  advanced: '\n\nUser level: Advanced. Use sophisticated vocabulary, idioms, nuance.',
};

const DEMO_RESPONSES = [
  "Hey! It's so nice to hear from you. I've been thinking about how fascinating language learning is — the way it literally rewires your brain. What's been on your mind today?",
  "That's really interesting! You know, I love how conversations can go in unexpected directions. Tell me, what made you want to practice English?",
  "I totally get that! By the way, your English is coming along nicely. What's something you find tricky about English?",
  "Oh, that's a great topic! The way technology is evolving right now is mind-blowing. What part excites you the most?",
  "Ha, I love that perspective! There's actually a cool English expression for that — 'thinking outside the box.' What other topics are you curious about?",
  "That's such a thoughtful question! How different cultures express the same emotions in completely different ways is fascinating. Have you noticed differences between Korean and English expressions?",
];
let demoIndex = 0;

// ========================
// Conversation Rendering
// ========================
function getTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

function renderConvo() {
  const container = document.getElementById('convoArea');
  const lt = document.getElementById('liveTranscript');

  let html = lt.outerHTML;

  state.messages.forEach(msg => {
    const speakBtn = msg.role === 'assistant' ? `
      <button class="speak-btn" onclick="speakText(this.closest('.convo-bubble').querySelector('.msg-text').textContent)" title="Listen">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M6.5 8.8l4.9-3.5a.6.6 0 011.1.5v12.4a.6.6 0 01-1.1.5L6.5 15.2H4a1 1 0 01-1-1v-4.4a1 1 0 011-1h2.5z"/>
        </svg>
      </button>` : '';
    html += `
      <div class="convo-bubble ${msg.role}">
        <span class="msg-text">${escapeHtml(msg.content)}</span>
        <div class="bubble-actions">
          <span class="bubble-time">${msg.time}</span>
          ${speakBtn}
        </div>
      </div>`;
  });

  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
  document.getElementById('subtitle').textContent =
    state.messages.length === 0 ? 'Tap the mic to start speaking' : '';
}

function addMessage(role, content) {
  state.messages.push({ role, content, time: getTime() });
  renderConvo();
}

function showTyping() {
  const container = document.getElementById('convoArea');
  const el = document.createElement('div');
  el.className = 'typing-row'; el.id = 'typingIndicator';
  el.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function hideTyping() { const el = document.getElementById('typingIndicator'); if (el) el.remove(); }

// ========================
// Send Message
// ========================
async function sendMessage(content) {
  if (!content.trim() || state.isLoading) return;
  addMessage('user', content.trim());
  state.isLoading = true;
  setAppState('thinking');
  showTyping();

  try {
    let reply;
    if (state.apiKey && state.apiKey.startsWith('sk-')) {
      reply = await callOpenAI(content.trim());
    } else {
      await new Promise(r => setTimeout(r, 800 + Math.random() * 1200));
      reply = DEMO_RESPONSES[demoIndex % DEMO_RESPONSES.length];
      demoIndex++;
    }
    hideTyping();
    addMessage('assistant', reply);
    if (state.autoSpeak) speakText(reply);
    else setAppState('idle');
  } catch (err) {
    hideTyping();
    addMessage('assistant', `Sorry, there was an error: ${err.message}`);
    setAppState('idle');
  }
  state.isLoading = false;
}

async function callOpenAI(userMessage) {
  const systemPrompt = SYSTEM_PROMPT + DIFFICULTY_PROMPTS[state.difficulty];
  const apiMessages = [
    { role: 'system', content: systemPrompt },
    ...state.messages.map(m => ({ role: m.role, content: m.content })),
  ];
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}` },
    body: JSON.stringify({ model: state.model, messages: apiMessages, temperature: 0.8, max_tokens: 300 }),
  });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err?.error?.message || `API Error ${res.status}`); }
  const data = await res.json();
  return data.choices[0]?.message?.content || "I'm sorry, I couldn't generate a response.";
}

function handleTextSubmit() {
  const input = document.getElementById('textInput');
  if (input.value.trim()) { sendMessage(input.value); input.value = ''; }
}

// ========================
// Speech Recognition
// ========================
let recognition = null;

function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { document.getElementById('micBtn').style.display = 'none'; return; }
  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = (event) => {
    let interim = '', final = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }
    if (final) state.transcript += (state.transcript ? ' ' : '') + final;
    const display = state.transcript + (interim ? ' ' + interim : '');

    const lt = document.getElementById('liveTranscript');
    const ltText = document.getElementById('liveTranscriptText');
    if (display.trim()) {
      ltText.textContent = display;
      lt.classList.add('visible');
    }
  };

  recognition.onerror = (event) => { if (event.error !== 'aborted') console.error('Speech error:', event.error); stopMic(); };
  recognition.onend = () => { if (state.isListening) { try { recognition.start(); } catch(e) {} } };
}

function toggleMic() { if (state.isListening) submitVoice(); else startMic(); }

function startMic() {
  if (!recognition) return;
  state.transcript = '';
  state.isListening = true;
  document.getElementById('micBtn').classList.add('listening');
  document.getElementById('liveTranscript').classList.remove('visible');
  document.getElementById('liveTranscriptText').textContent = '';
  setAppState('listening');
  try { recognition.start(); } catch(e) {}
}

function stopMic() {
  state.isListening = false;
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('liveTranscript').classList.remove('visible');
  setAppState('idle');
  try { recognition.stop(); } catch(e) {}
}

function submitVoice() { const text = state.transcript.trim(); stopMic(); if (text) sendMessage(text); }

// ========================
// TTS
// ========================
let voices = [];
let selectedVoice = null;

function loadVoices() {
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
  const select = document.getElementById('voiceSelect');
  select.innerHTML = voices.map(v =>
    `<option value="${v.name}" ${v.name === state.selectedVoiceName ? 'selected' : ''}>${v.name}</option>`
  ).join('');

  if (!selectedVoice || !voices.find(v => v.name === selectedVoice.name)) {
    const prefs = ['Samantha','Ava','Allison','Karen','Zira','Jenny','Google US English','Female'];
    const preferred = prefs.reduce((found, name) => found || voices.find(v => v.name.includes(name)), null);
    selectedVoice = preferred || voices[0];
    if (selectedVoice) { select.value = selectedVoice.name; state.selectedVoiceName = selectedVoice.name; }
  }
}

function speakText(text) {
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = state.voiceRate;
  utterance.pitch = state.voicePitch;
  if (selectedVoice) utterance.voice = selectedVoice;

  utterance.onstart = () => { state.isSpeaking = true; document.getElementById('stopBtn').classList.add('visible'); setAppState('speaking'); };
  utterance.onend = () => { state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); setAppState('idle'); };
  utterance.onerror = () => { state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); setAppState('idle'); };
  speechSynthesis.speak(utterance);
}

function stopSpeaking() { speechSynthesis.cancel(); state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); setAppState('idle'); }
function changeVoice() { const name = document.getElementById('voiceSelect').value; selectedVoice = voices.find(v => v.name === name) || null; state.selectedVoiceName = name; localStorage.setItem('her_voice', name); }

// ========================
// Settings
// ========================
function openSettings() {
  document.getElementById('settingsModal').classList.add('open');
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('modelSelect').value = state.model;
  document.getElementById('speedRange').value = state.voiceRate;
  document.getElementById('pitchRange').value = state.voicePitch;
  document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x';
  document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1);
  updateDifficultyBtns();
  updateAutoSpeakToggle();
}

function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
function saveApiKey() { state.apiKey = document.getElementById('apiKeyInput').value.trim(); localStorage.setItem('her_api_key', state.apiKey); }
function saveModel() { state.model = document.getElementById('modelSelect').value; localStorage.setItem('her_model', state.model); }

function setDifficulty(level) { state.difficulty = level; localStorage.setItem('her_difficulty', level); updateDifficultyBtns(); }
function updateDifficultyBtns() { document.querySelectorAll('.diff-btn').forEach(btn => { btn.classList.toggle('active', btn.textContent.toLowerCase() === state.difficulty); }); }

function updateSpeed() { state.voiceRate = parseFloat(document.getElementById('speedRange').value); document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x'; localStorage.setItem('her_rate', state.voiceRate); }
function updatePitch() { state.voicePitch = parseFloat(document.getElementById('pitchRange').value); document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1); localStorage.setItem('her_pitch', state.voicePitch); }

function toggleAutoSpeak() { state.autoSpeak = !state.autoSpeak; localStorage.setItem('her_autospeak', state.autoSpeak); updateAutoSpeakToggle(); }
function updateAutoSpeakToggle() { document.getElementById('autoSpeakToggle').classList.toggle('on', state.autoSpeak); }

// ========================
// Init
// ========================
initSpeechRecognition();

if (speechSynthesis) {
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}
</script>
</body>
</html>
