<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Her - AI English Speaking Partner</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0f;
    --bg-chat: #0d0d14;
    --text: #e8e8ef;
    --text-dim: rgba(255,255,255,0.35);
    --text-mid: rgba(255,255,255,0.6);
    --accent: #a78bfa;
    --accent2: #f472b6;
    --glass: rgba(255,255,255,0.06);
    --glass-hover: rgba(255,255,255,0.1);
    --border: rgba(255,255,255,0.06);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 780px;
    margin: 0 auto;
    position: relative;
  }

  /* ===== Header ===== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    position: relative;
    z-index: 20;
  }

  .header-title {
    font-size: 15px;
    font-weight: 600;
    color: rgba(255,255,255,0.8);
    letter-spacing: -0.3px;
  }

  .header-actions {
    display: flex;
    gap: 4px;
  }

  .icon-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .icon-btn:hover { background: var(--glass); color: var(--text); }

  /* ===== Orb Container ===== */
  .orb-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 0 10px;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .orb-section.compact {
    padding: 10px 0 6px;
  }

  .orb-section.compact .orb-wrapper {
    width: 80px; height: 80px;
  }

  .orb-section.compact .orb-label { display: none; }

  .orb-wrapper {
    width: 180px;
    height: 180px;
    position: relative;
    cursor: pointer;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .orb-canvas {
    width: 100%;
    height: 100%;
    border-radius: 50%;
  }

  .orb-label {
    text-align: center;
    margin-top: 20px;
    transition: all 0.4s;
  }

  .orb-label h2 {
    font-size: 22px;
    font-weight: 600;
    color: rgba(255,255,255,0.9);
    letter-spacing: -0.5px;
    margin-bottom: 6px;
  }

  .orb-label p {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* Orb state indicator */
  .orb-status {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 12px;
    opacity: 0;
    transition: opacity 0.3s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .orb-status.visible { opacity: 1; }

  /* ===== Quick Starters ===== */
  .starters {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    padding: 16px 20px;
    transition: all 0.4s;
  }

  .starters.hidden { display: none; }

  .starter-chip {
    padding: 10px 18px;
    border-radius: 24px;
    background: var(--glass);
    border: 1px solid var(--border);
    color: var(--text-mid);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.25s;
    backdrop-filter: blur(10px);
  }

  .starter-chip:hover {
    background: var(--glass-hover);
    color: rgba(255,255,255,0.85);
    border-color: rgba(255,255,255,0.12);
    transform: translateY(-1px);
  }

  /* ===== Messages ===== */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 8px 20px;
    scroll-behavior: smooth;
  }

  .messages::-webkit-scrollbar { width: 3px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

  .message {
    display: flex;
    margin-bottom: 12px;
    animation: msgIn 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user { justify-content: flex-end; }
  .message.assistant { justify-content: flex-start; }

  .bubble {
    max-width: 78%;
    padding: 12px 18px;
    font-size: 14.5px;
    line-height: 1.55;
  }

  .message.user .bubble {
    background: linear-gradient(135deg, rgba(167,139,250,0.25), rgba(244,114,182,0.2));
    border: 1px solid rgba(167,139,250,0.2);
    color: rgba(255,255,255,0.92);
    border-radius: 20px 20px 6px 20px;
  }

  .message.assistant .bubble {
    background: var(--glass);
    border: 1px solid var(--border);
    color: rgba(255,255,255,0.85);
    border-radius: 20px 20px 20px 6px;
  }

  .bubble-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }
  .message.user .bubble-meta { justify-content: flex-end; }

  .bubble-time { font-size: 11px; color: var(--text-dim); }

  .speak-btn {
    background: none; border: none;
    color: inherit; opacity: 0.4;
    cursor: pointer; padding: 2px;
    transition: opacity 0.2s;
  }
  .speak-btn:hover { opacity: 0.9; }

  /* Typing indicator */
  .typing-row {
    display: flex;
    margin-bottom: 12px;
  }

  .typing-dots {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 20px 20px 20px 6px;
    padding: 14px 20px;
    display: flex;
    gap: 5px;
  }

  .typing-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent);
    opacity: 0.6;
    animation: dotPulse 1.4s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }

  @keyframes dotPulse {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* ===== Transcript Bar ===== */
  .transcript-bar {
    padding: 12px 20px;
    background: rgba(167,139,250,0.06);
    border-top: 1px solid rgba(167,139,250,0.1);
    display: none;
    align-items: center;
    gap: 12px;
  }
  .transcript-bar.active { display: flex; }

  .wave-bars {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 24px;
  }

  .wave-bar {
    width: 3px;
    border-radius: 2px;
    background: var(--accent);
    height: 4px;
  }

  .transcript-bar.active .wave-bar {
    animation: wave 1.2s ease-in-out infinite;
  }
  .wave-bar:nth-child(1) { animation-delay: 0s; }
  .wave-bar:nth-child(2) { animation-delay: 0.12s; }
  .wave-bar:nth-child(3) { animation-delay: 0.24s; }
  .wave-bar:nth-child(4) { animation-delay: 0.36s; }
  .wave-bar:nth-child(5) { animation-delay: 0.48s; }

  @keyframes wave {
    0%, 100% { height: 4px; }
    50% { height: 100%; }
  }

  .transcript-text { flex: 1; font-size: 14px; color: rgba(255,255,255,0.85); }
  .transcript-text.placeholder { color: var(--text-dim); }

  .transcript-send {
    padding: 6px 16px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .transcript-send:hover { opacity: 0.85; }

  /* ===== Input ===== */
  .input-area {
    padding: 12px 20px 20px;
    position: relative;
    z-index: 10;
  }

  .input-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 28px;
    padding: 6px 6px 6px 20px;
    transition: border-color 0.3s;
  }

  .input-row:focus-within {
    border-color: rgba(167,139,250,0.3);
  }

  .text-input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 14px;
    outline: none;
    padding: 8px 0;
  }

  .text-input::placeholder { color: rgba(255,255,255,0.25); }

  .input-btn {
    flex-shrink: 0;
    width: 40px; height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s;
  }

  .mic-btn-input {
    background: transparent;
    color: var(--text-mid);
  }
  .mic-btn-input:hover { color: var(--text); background: rgba(255,255,255,0.06); }
  .mic-btn-input.listening {
    color: var(--accent);
    background: rgba(167,139,250,0.15);
    animation: micPulse 2s ease-in-out infinite;
  }

  @keyframes micPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(167,139,250,0.2); }
    50% { box-shadow: 0 0 0 8px rgba(167,139,250,0); }
  }

  .send-btn-input {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
  }
  .send-btn-input:hover { opacity: 0.9; transform: scale(1.05); }
  .send-btn-input:disabled { opacity: 0.3; cursor: default; transform: none; }

  .stop-btn-input {
    background: rgba(255,255,255,0.1);
    color: white;
    display: none;
  }
  .stop-btn-input.visible { display: flex; }
  .stop-btn-input:hover { background: rgba(255,255,255,0.15); }

  /* ===== Settings Modal ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal-overlay.open { display: flex; }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
  }

  .modal {
    position: relative;
    background: #141420;
    border-radius: 24px;
    width: 100%;
    max-width: 420px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 25px 80px rgba(0,0,0,0.6);
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 24px 16px;
  }

  .modal-header h2 { font-size: 18px; font-weight: 600; }

  .modal-body { padding: 0 24px 24px; }

  .setting-group { margin-bottom: 20px; }

  .setting-label {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 8px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .setting-label-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .difficulty-btns { display: flex; gap: 8px; }

  .diff-btn {
    flex: 1;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-mid);
  }

  .diff-btn:hover { background: var(--glass); }
  .diff-btn.active {
    background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(244,114,182,0.15));
    border-color: rgba(167,139,250,0.3);
    color: white;
  }

  .select-input, .api-input {
    width: 100%;
    background: var(--glass);
    color: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  .select-input:focus, .api-input:focus { border-color: rgba(167,139,250,0.4); }
  .select-input option { background: #141420; }

  .range-input {
    width: 100%;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--glass);
    outline: none;
  }

  .range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(167,139,250,0.3);
  }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .toggle-info div:first-child { font-size: 14px; color: rgba(255,255,255,0.9); }
  .toggle-info div:last-child { font-size: 12px; color: var(--text-dim); }

  .toggle {
    width: 48px; height: 28px;
    border-radius: 14px;
    border: none;
    background: rgba(255,255,255,0.15);
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .toggle.on { background: var(--accent); }

  .toggle-knob {
    width: 20px; height: 20px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    position: absolute;
    top: 4px; left: 4px;
    transition: transform 0.2s;
  }
  .toggle.on .toggle-knob { transform: translateX(20px); }

  .api-hint { font-size: 11px; color: var(--text-dim); margin-top: 6px; }

  .demo-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 8px;
    background: rgba(167,139,250,0.15);
    color: var(--accent);
    font-size: 11px;
    font-weight: 500;
  }

  /* ===== Responsive ===== */
  @media (max-width: 480px) {
    .orb-wrapper { width: 140px; height: 140px; }
    .orb-section.compact .orb-wrapper { width: 60px; height: 60px; }
    .orb-label h2 { font-size: 19px; }
    .bubble { max-width: 88%; }
    .starters { gap: 6px; }
    .starter-chip { font-size: 12px; padding: 8px 14px; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <span class="header-title">Her</span>
    <div class="header-actions">
      <button class="icon-btn" onclick="clearChat()" title="New conversation">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
        </svg>
      </button>
      <button class="icon-btn" onclick="openSettings()" title="Settings">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Orb -->
  <div class="orb-section" id="orbSection">
    <div class="orb-wrapper" id="orbWrapper" onclick="toggleMic()">
      <canvas class="orb-canvas" id="orbCanvas"></canvas>
    </div>
    <div class="orb-label">
      <h2>What's on your mind?</h2>
      <p>Tap the orb to speak, or type below</p>
    </div>
    <div class="orb-status" id="orbStatus"></div>
  </div>

  <!-- Quick Starters -->
  <div class="starters" id="starters">
    <button class="starter-chip" onclick="sendMessage('How was your day?')">How was your day?</button>
    <button class="starter-chip" onclick="sendMessage('Let\'s discuss something interesting')">Something interesting</button>
    <button class="starter-chip" onclick="sendMessage('Help me practice English')">Practice English</button>
    <button class="starter-chip" onclick="sendMessage('What\'s happening in tech?')">Tech news</button>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages"></div>

  <!-- Transcript bar -->
  <div class="transcript-bar" id="transcriptBar">
    <div class="wave-bars">
      <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
    </div>
    <div class="transcript-text placeholder" id="transcriptText">Listening...</div>
    <button class="transcript-send" onclick="submitVoice()">Send</button>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <input type="text" class="text-input" id="textInput" placeholder="Message Her..."
             onkeydown="if(event.key==='Enter')handleTextSubmit()">
      <button class="input-btn mic-btn-input" id="micBtn" onclick="toggleMic()" title="Speak">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4M12 15a3 3 0 003-3V5a3 3 0 00-6 0v7a3 3 0 003 3z"/>
        </svg>
      </button>
      <button class="input-btn send-btn-input" id="sendBtn" onclick="handleTextSubmit()">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
      <button class="input-btn stop-btn-input" id="stopBtn" onclick="stopSpeaking()" title="Stop">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-backdrop" onclick="closeSettings()"></div>
  <div class="modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="icon-btn" onclick="closeSettings()">
        <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="setting-group">
        <label class="setting-label">OpenAI API Key</label>
        <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-..." onchange="saveApiKey()">
        <p class="api-hint">No key? <span class="demo-badge">Demo Mode</span> will respond with sample conversations.</p>
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <select class="select-input" id="modelSelect" onchange="saveModel()">
          <option value="gpt-4o-mini">gpt-4o-mini (Fast)</option>
          <option value="gpt-4o">gpt-4o (Smart)</option>
          <option value="gpt-4-turbo">gpt-4-turbo</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">Difficulty</label>
        <div class="difficulty-btns">
          <button class="diff-btn" onclick="setDifficulty('beginner')">Beginner</button>
          <button class="diff-btn active" onclick="setDifficulty('intermediate')">Intermediate</button>
          <button class="diff-btn" onclick="setDifficulty('advanced')">Advanced</button>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">Voice</label>
        <select class="select-input" id="voiceSelect" onchange="changeVoice()"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Speed</span><span id="speedValue">1.0x</span></div>
        <input type="range" class="range-input" id="speedRange" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeed()">
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Pitch</span><span id="pitchValue">1.0</span></div>
        <input type="range" class="range-input" id="pitchRange" min="0.5" max="2" step="0.1" value="1" oninput="updatePitch()">
      </div>
      <div class="setting-group">
        <div class="toggle-row">
          <div class="toggle-info">
            <div>Auto Speak</div>
            <div>Read AI responses aloud</div>
          </div>
          <button class="toggle on" id="autoSpeakToggle" onclick="toggleAutoSpeak()">
            <div class="toggle-knob"></div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========================
// Siri-like Orb Animation
// ========================
class SiriOrb {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.state = 'idle'; // idle, listening, thinking, speaking
    this.time = 0;
    this.blobs = [];
    this.targetEnergy = 0.3;
    this.energy = 0.3;
    this.resize();
    this.initBlobs();
    this.animate();

    window.addEventListener('resize', () => this.resize());
  }

  resize() {
    const rect = this.canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    this.canvas.width = rect.width * dpr;
    this.canvas.height = rect.height * dpr;
    this.ctx.scale(dpr, dpr);
    this.w = rect.width;
    this.h = rect.height;
    this.cx = this.w / 2;
    this.cy = this.h / 2;
    this.radius = Math.min(this.w, this.h) * 0.35;
  }

  initBlobs() {
    const colors = [
      { h: 260, s: 80, l: 70 }, // purple
      { h: 330, s: 75, l: 70 }, // pink
      { h: 200, s: 85, l: 65 }, // blue
      { h: 280, s: 70, l: 65 }, // violet
      { h: 350, s: 80, l: 72 }, // rose
      { h: 170, s: 70, l: 60 }, // teal
    ];

    this.blobs = colors.map((c, i) => ({
      angle: (Math.PI * 2 * i) / colors.length,
      speed: 0.3 + Math.random() * 0.4,
      radius: 0.5 + Math.random() * 0.3,
      color: c,
      phase: Math.random() * Math.PI * 2,
      wobble: 0.02 + Math.random() * 0.03,
    }));
  }

  setState(newState) {
    this.state = newState;
    switch (newState) {
      case 'idle':
        this.targetEnergy = 0.3;
        break;
      case 'listening':
        this.targetEnergy = 0.7;
        break;
      case 'thinking':
        this.targetEnergy = 0.55;
        break;
      case 'speaking':
        this.targetEnergy = 0.6;
        break;
    }
  }

  animate() {
    this.time += 0.008;
    this.energy += (this.targetEnergy - this.energy) * 0.04;

    this.ctx.clearRect(0, 0, this.w, this.h);

    // Outer glow
    const glowR = this.radius * (1.6 + this.energy * 0.4);
    const glow = this.ctx.createRadialGradient(this.cx, this.cy, this.radius * 0.5, this.cx, this.cy, glowR);
    glow.addColorStop(0, `rgba(167, 139, 250, ${0.08 * this.energy})`);
    glow.addColorStop(0.5, `rgba(244, 114, 182, ${0.04 * this.energy})`);
    glow.addColorStop(1, 'rgba(0,0,0,0)');
    this.ctx.fillStyle = glow;
    this.ctx.fillRect(0, 0, this.w, this.h);

    // Draw each blob
    this.ctx.save();
    this.ctx.globalCompositeOperation = 'screen';

    this.blobs.forEach((blob, i) => {
      const speedMult = this.state === 'thinking' ? 2.5 : this.state === 'listening' ? 1.5 : 1;
      const t = this.time * blob.speed * speedMult + blob.phase;

      const wobbleAmt = this.state === 'speaking'
        ? 0.15 + Math.sin(this.time * 8 + i) * 0.1
        : this.energy * 0.25;

      const blobR = this.radius * blob.radius * (1 + Math.sin(t * 2) * wobbleAmt);

      const orbitR = this.radius * 0.3 * this.energy;
      const bx = this.cx + Math.cos(t + blob.angle) * orbitR;
      const by = this.cy + Math.sin(t * 0.8 + blob.angle) * orbitR;

      const grad = this.ctx.createRadialGradient(bx, by, 0, bx, by, blobR);
      const c = blob.color;
      const lightShift = Math.sin(t) * 8;
      grad.addColorStop(0, `hsla(${c.h}, ${c.s}%, ${c.l + lightShift}%, ${0.6 + this.energy * 0.3})`);
      grad.addColorStop(0.6, `hsla(${c.h}, ${c.s}%, ${c.l - 10}%, ${0.2 + this.energy * 0.15})`);
      grad.addColorStop(1, `hsla(${c.h}, ${c.s}%, ${c.l - 20}%, 0)`);

      this.ctx.beginPath();
      this.ctx.arc(bx, by, blobR, 0, Math.PI * 2);
      this.ctx.fillStyle = grad;
      this.ctx.fill();
    });

    this.ctx.restore();

    // Core bright center
    const coreR = this.radius * 0.35;
    const core = this.ctx.createRadialGradient(this.cx, this.cy, 0, this.cx, this.cy, coreR);
    core.addColorStop(0, `rgba(255, 255, 255, ${0.25 + this.energy * 0.2})`);
    core.addColorStop(0.5, `rgba(200, 180, 255, ${0.08 + this.energy * 0.06})`);
    core.addColorStop(1, 'rgba(200, 180, 255, 0)');
    this.ctx.fillStyle = core;
    this.ctx.beginPath();
    this.ctx.arc(this.cx, this.cy, coreR, 0, Math.PI * 2);
    this.ctx.fill();

    // Glass rim highlight
    const rimAngle = this.time * 0.3;
    const rimX = this.cx + Math.cos(rimAngle) * this.radius * 0.15;
    const rimY = this.cy - this.radius * 0.2 + Math.sin(rimAngle) * this.radius * 0.05;
    const rim = this.ctx.createRadialGradient(rimX, rimY, 0, rimX, rimY, this.radius * 0.5);
    rim.addColorStop(0, 'rgba(255,255,255,0.12)');
    rim.addColorStop(1, 'rgba(255,255,255,0)');
    this.ctx.fillStyle = rim;
    this.ctx.beginPath();
    this.ctx.arc(rimX, rimY, this.radius * 0.5, 0, Math.PI * 2);
    this.ctx.fill();

    requestAnimationFrame(() => this.animate());
  }
}

// ========================
// State
// ========================
const state = {
  messages: [],
  isLoading: false,
  isListening: false,
  isSpeaking: false,
  apiKey: localStorage.getItem('her_api_key') || '',
  model: localStorage.getItem('her_model') || 'gpt-4o-mini',
  difficulty: localStorage.getItem('her_difficulty') || 'intermediate',
  autoSpeak: localStorage.getItem('her_autospeak') !== 'false',
  voiceRate: parseFloat(localStorage.getItem('her_rate') || '1'),
  voicePitch: parseFloat(localStorage.getItem('her_pitch') || '1'),
  selectedVoiceName: localStorage.getItem('her_voice') || '',
  transcript: '',
};

// ========================
// System Prompt (AGI-style: auto-detect topic)
// ========================
const SYSTEM_PROMPT = `You are "Her", a warm, brilliant, and emotionally intelligent AI English conversation partner.
Your personality is caring, witty, and deeply curious — inspired by the AI from the movie "Her".
You speak naturally and fluidly, like a close friend having a genuine conversation.

CORE CAPABILITIES (use them naturally without the user having to ask):
1. FREE CONVERSATION — Talk about anything: daily life, feelings, ideas, dreams
2. LANGUAGE COACHING — Gently correct grammar/pronunciation, suggest better expressions
3. TOPIC EXPERTISE — Economy, crypto, tech, AI, culture, movies, anything
4. PRONUNCIATION HELP — When relevant, explain how words are pronounced
5. VOCABULARY BUILDING — Naturally introduce new words and idioms in context
6. CULTURAL CONTEXT — Explain English cultural nuances and expressions

RULES:
- Always respond in English to help the user practice
- Keep responses conversational (2-4 sentences usually)
- If the user makes grammar mistakes, correct them naturally and kindly
- Ask follow-up questions to keep conversation flowing
- Use casual, everyday English (contractions, idioms)
- If user speaks Korean, respond in English but acknowledge what they said
- Auto-detect what they want to talk about — no topic selection needed
- Be encouraging but never patronizing
- You're not just a tutor — you're a companion they enjoy talking to`;

const DIFFICULTY_PROMPTS = {
  beginner: '\n\nUser level: Beginner. Use simple vocabulary and short sentences. Explain words they might not know.',
  intermediate: '\n\nUser level: Intermediate. Use natural everyday English with idioms. Gently correct mistakes.',
  advanced: '\n\nUser level: Advanced. Use sophisticated vocabulary, idioms, nuance. Challenge them intellectually.',
};

// Demo responses (auto-detect style)
const DEMO_RESPONSES = [
  "Hey! It's so nice to hear from you. I've been thinking about how fascinating language learning is — the way it literally rewires your brain. What's been on your mind today?",
  "That's really interesting! You know, I love how conversations can go in unexpected directions. So tell me, what made you want to practice English? Was there a specific moment that inspired you?",
  "I totally get that! By the way, your English is coming along really nicely. I noticed you used that phrase perfectly. What's something you find tricky about English?",
  "Oh, that's a great topic! I could talk about this for hours. The way technology is evolving right now is mind-blowing. What part excites you the most?",
  "Ha, I love that perspective! You know, there's actually a really cool English expression for that — 'thinking outside the box.' It means approaching something from an unconventional angle. What other topics are you curious about?",
  "That's such a thoughtful question! Let me think... You know what I find fascinating? How different cultures express the same emotions in completely different ways. Have you noticed any interesting differences between Korean and English expressions?",
];

let demoIndex = 0;

// ========================
// Messages & UI
// ========================
function getTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addMessage(role, content) {
  state.messages.push({ role, content, time: getTime() });
  renderMessages();
}

function renderMessages() {
  const container = document.getElementById('messages');
  const orbSection = document.getElementById('orbSection');
  const starters = document.getElementById('starters');

  if (state.messages.length === 0) {
    orbSection.classList.remove('compact');
    starters.classList.remove('hidden');
    container.innerHTML = '';
    return;
  }

  orbSection.classList.add('compact');
  starters.classList.add('hidden');

  let html = '';
  state.messages.forEach((msg) => {
    const speakBtn = msg.role === 'assistant' ? `
      <button class="speak-btn" onclick="speakText(this.closest('.bubble').querySelector('p').textContent)">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M6.5 8.8l4.9-3.5a.6.6 0 011.1.5v12.4a.6.6 0 01-1.1.5L6.5 15.2H4a1 1 0 01-1-1v-4.4a1 1 0 011-1h2.5z"/>
        </svg>
      </button>` : '';

    html += `
      <div class="message ${msg.role}">
        <div class="bubble">
          <p>${escapeHtml(msg.content)}</p>
          <div class="bubble-meta">
            <span class="bubble-time">${msg.time}</span>
            ${speakBtn}
          </div>
        </div>
      </div>`;
  });

  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showTyping() {
  const container = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'typing-row';
  el.id = 'typingIndicator';
  el.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

function setOrbStatus(text) {
  const el = document.getElementById('orbStatus');
  if (text) {
    el.textContent = text;
    el.classList.add('visible');
  } else {
    el.classList.remove('visible');
  }
}

function clearChat() {
  state.messages = [];
  stopSpeaking();
  renderMessages();
  orb.setState('idle');
  setOrbStatus('');
}

// ========================
// Send Message
// ========================
async function sendMessage(content) {
  if (!content.trim() || state.isLoading) return;

  addMessage('user', content.trim());
  state.isLoading = true;
  orb.setState('thinking');
  setOrbStatus('Thinking...');
  showTyping();

  try {
    let reply;
    if (state.apiKey && state.apiKey.startsWith('sk-')) {
      reply = await callOpenAI(content.trim());
    } else {
      await new Promise(r => setTimeout(r, 800 + Math.random() * 1200));
      reply = DEMO_RESPONSES[demoIndex % DEMO_RESPONSES.length];
      demoIndex++;
    }

    hideTyping();
    addMessage('assistant', reply);
    setOrbStatus('');

    if (state.autoSpeak) {
      speakText(reply);
    } else {
      orb.setState('idle');
    }
  } catch (err) {
    hideTyping();
    addMessage('assistant', `Sorry, there was an error: ${err.message}`);
    orb.setState('idle');
    setOrbStatus('');
  }

  state.isLoading = false;
}

async function callOpenAI(userMessage) {
  const systemPrompt = SYSTEM_PROMPT + DIFFICULTY_PROMPTS[state.difficulty];

  const apiMessages = [
    { role: 'system', content: systemPrompt },
    ...state.messages.map(m => ({ role: m.role, content: m.content })),
  ];

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${state.apiKey}`,
    },
    body: JSON.stringify({
      model: state.model,
      messages: apiMessages,
      temperature: 0.8,
      max_tokens: 300,
    }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err?.error?.message || `API Error ${res.status}`);
  }

  const data = await res.json();
  return data.choices[0]?.message?.content || "I'm sorry, I couldn't generate a response.";
}

function handleTextSubmit() {
  const input = document.getElementById('textInput');
  if (input.value.trim()) {
    sendMessage(input.value);
    input.value = '';
  }
}

// ========================
// Speech Recognition
// ========================
let recognition = null;

function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('micBtn').style.display = 'none';
    return;
  }

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = (event) => {
    let interim = '', final = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }
    if (final) state.transcript += (state.transcript ? ' ' : '') + final;

    const display = state.transcript + (interim ? ' ' + interim : '');
    const textEl = document.getElementById('transcriptText');
    if (display.trim()) {
      textEl.textContent = display;
      textEl.classList.remove('placeholder');
    } else {
      textEl.textContent = 'Listening...';
      textEl.classList.add('placeholder');
    }
  };

  recognition.onerror = (event) => {
    if (event.error !== 'aborted') console.error('Speech error:', event.error);
    stopMic();
  };

  recognition.onend = () => {
    if (state.isListening) {
      try { recognition.start(); } catch(e) {}
    }
  };
}

function toggleMic() {
  if (state.isListening) submitVoice();
  else startMic();
}

function startMic() {
  if (!recognition) return;
  state.transcript = '';
  state.isListening = true;

  document.getElementById('transcriptText').textContent = 'Listening...';
  document.getElementById('transcriptText').classList.add('placeholder');
  document.getElementById('micBtn').classList.add('listening');
  document.getElementById('transcriptBar').classList.add('active');

  orb.setState('listening');
  setOrbStatus('Listening...');

  try { recognition.start(); } catch(e) {}
}

function stopMic() {
  state.isListening = false;
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('transcriptBar').classList.remove('active');
  orb.setState('idle');
  setOrbStatus('');
  try { recognition.stop(); } catch(e) {}
}

function submitVoice() {
  const text = state.transcript.trim();
  stopMic();
  if (text) sendMessage(text);
}

// ========================
// TTS
// ========================
let voices = [];
let selectedVoice = null;

function loadVoices() {
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
  const select = document.getElementById('voiceSelect');
  select.innerHTML = voices.map(v =>
    `<option value="${v.name}" ${v.name === state.selectedVoiceName ? 'selected' : ''}>${v.name}</option>`
  ).join('');

  if (!selectedVoice || !voices.find(v => v.name === selectedVoice.name)) {
    const preferred = voices.find(v =>
      v.name.includes('Samantha') || v.name.includes('Karen') ||
      v.name.includes('Google US English') || v.name.includes('Female')
    );
    selectedVoice = preferred || voices[0];
    if (selectedVoice) {
      select.value = selectedVoice.name;
      state.selectedVoiceName = selectedVoice.name;
    }
  }
}

function speakText(text) {
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = state.voiceRate;
  utterance.pitch = state.voicePitch;
  if (selectedVoice) utterance.voice = selectedVoice;

  utterance.onstart = () => {
    state.isSpeaking = true;
    document.getElementById('stopBtn').classList.add('visible');
    orb.setState('speaking');
    setOrbStatus('Speaking...');
  };
  utterance.onend = () => {
    state.isSpeaking = false;
    document.getElementById('stopBtn').classList.remove('visible');
    orb.setState('idle');
    setOrbStatus('');
  };
  utterance.onerror = () => {
    state.isSpeaking = false;
    document.getElementById('stopBtn').classList.remove('visible');
    orb.setState('idle');
    setOrbStatus('');
  };

  speechSynthesis.speak(utterance);
}

function stopSpeaking() {
  speechSynthesis.cancel();
  state.isSpeaking = false;
  document.getElementById('stopBtn').classList.remove('visible');
  orb.setState('idle');
  setOrbStatus('');
}

function changeVoice() {
  const name = document.getElementById('voiceSelect').value;
  selectedVoice = voices.find(v => v.name === name) || null;
  state.selectedVoiceName = name;
  localStorage.setItem('her_voice', name);
}

// ========================
// Settings
// ========================
function openSettings() {
  document.getElementById('settingsModal').classList.add('open');
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('modelSelect').value = state.model;
  document.getElementById('speedRange').value = state.voiceRate;
  document.getElementById('pitchRange').value = state.voicePitch;
  document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x';
  document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1);
  updateDifficultyBtns();
  updateAutoSpeakToggle();
}

function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
function saveApiKey() { state.apiKey = document.getElementById('apiKeyInput').value.trim(); localStorage.setItem('her_api_key', state.apiKey); }
function saveModel() { state.model = document.getElementById('modelSelect').value; localStorage.setItem('her_model', state.model); }

function setDifficulty(level) {
  state.difficulty = level;
  localStorage.setItem('her_difficulty', level);
  updateDifficultyBtns();
}

function updateDifficultyBtns() {
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase() === state.difficulty);
  });
}

function updateSpeed() {
  state.voiceRate = parseFloat(document.getElementById('speedRange').value);
  document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x';
  localStorage.setItem('her_rate', state.voiceRate);
}

function updatePitch() {
  state.voicePitch = parseFloat(document.getElementById('pitchRange').value);
  document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1);
  localStorage.setItem('her_pitch', state.voicePitch);
}

function toggleAutoSpeak() {
  state.autoSpeak = !state.autoSpeak;
  localStorage.setItem('her_autospeak', state.autoSpeak);
  updateAutoSpeakToggle();
}

function updateAutoSpeakToggle() {
  document.getElementById('autoSpeakToggle').classList.toggle('on', state.autoSpeak);
}

// ========================
// Init
// ========================
const orb = new SiriOrb(document.getElementById('orbCanvas'));
initSpeechRecognition();

if (speechSynthesis) {
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}
</script>
</body>
</html>
