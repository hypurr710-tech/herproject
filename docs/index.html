<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Her - AI English Speaking Partner</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #08080f;
    --accent: #a78bfa;
    --accent-dark: #8b5cf6;
    --accent-pink: #f472b6;
    --text: #e8e8ef;
    --text-dim: rgba(255,255,255,0.25);
    --text-mid: rgba(255,255,255,0.6);
    --glass: rgba(255,255,255,0.06);
    --glass-hover: rgba(255,255,255,0.1);
    --border: rgba(255,255,255,0.06);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 780px;
    margin: 0 auto;
    position: relative;
  }

  .ambient-glow {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(ellipse 60% 50% at 50% 40%, rgba(167,139,250,0.06) 0%, rgba(8,8,15,0) 70%);
    z-index: 0;
  }

  /* ===== Header ===== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    position: relative;
    z-index: 20;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    background: rgba(8,8,15,0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .header-left { display: flex; align-items: center; gap: 10px; }

  .back-btn {
    width: 36px; height: 36px;
    border-radius: 50%; border: none;
    background: transparent; color: var(--text-mid);
    cursor: pointer; display: none;
    align-items: center; justify-content: center;
    transition: all 0.2s; margin-left: -4px;
  }
  .back-btn:hover { background: var(--glass-hover); color: var(--text); }
  .back-btn.visible { display: flex; }

  .header-logo {
    width: 32px; height: 32px; border-radius: 50%;
    background: linear-gradient(135deg, #a78bfa, #f472b6, #60a5fa);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(167,139,250,0.25);
  }

  .header-logo-dot {
    width: 12px; height: 12px; border-radius: 50%;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 6px rgba(255,255,255,0.3);
  }

  .header-info h1 { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
  .header-info p { font-size: 11px; color: rgba(255,255,255,0.3); }
  .header-actions { display: flex; gap: 4px; }

  .icon-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    background: transparent; color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .icon-btn:hover { background: var(--glass); color: var(--text-mid); }

  /* ===== FIGURE VIEW ===== */
  .orb-view {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; overflow: hidden;
  }
  .orb-view.hidden { display: none; }

  .orb-container {
    position: relative; display: flex;
    align-items: center; justify-content: center;
  }

  .orb-state-label {
    position: absolute; bottom: -24px; left: 50%;
    transform: translateX(-50%); white-space: nowrap;
    font-size: 12px; font-weight: 500; letter-spacing: 1.5px;
    text-transform: uppercase; opacity: 0; transition: opacity 0.3s;
  }
  .orb-state-label.visible { opacity: 1; }
  .orb-state-label.listening { color: var(--accent); }
  .orb-state-label.speaking { color: var(--accent-pink); }
  .orb-state-label.thinking { color: rgba(255,255,255,0.35); }

  .orb-subtitle {
    margin-top: 32px; text-align: center;
    font-size: 13px; color: var(--text-dim);
  }

  .live-transcript {
    position: absolute; bottom: 100px; left: 24px; right: 24px;
    display: none; animation: fadeUp 0.3s ease-out;
  }
  .live-transcript.visible { display: block; }

  .live-transcript-inner {
    max-width: 400px; margin: 0 auto;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 16px; padding: 12px 20px;
    border: 1px solid rgba(255,255,255,0.1);
    text-align: center; font-size: 14px; color: rgba(255,255,255,0.8);
  }

  .wave-bars {
    display: inline-flex; align-items: center; gap: 3px;
    height: 20px; vertical-align: middle; margin-right: 6px;
  }
  .wave-bar {
    width: 3px; border-radius: 2px; background: var(--accent);
    height: 4px; animation: wave 1.2s ease-in-out infinite;
  }
  .wave-bar:nth-child(1) { animation-delay: 0s; }
  .wave-bar:nth-child(2) { animation-delay: 0.12s; }
  .wave-bar:nth-child(3) { animation-delay: 0.24s; }
  .wave-bar:nth-child(4) { animation-delay: 0.36s; }
  .wave-bar:nth-child(5) { animation-delay: 0.48s; }

  @keyframes wave { 0%, 100% { height: 4px; } 50% { height: 100%; } }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* ===== CHAT VIEW ===== */
  .chat-view { flex: 1; overflow-y: auto; padding: 16px; scroll-behavior: smooth; display: none; }
  .chat-view.visible { display: block; }
  .chat-view::-webkit-scrollbar { width: 3px; }
  .chat-view::-webkit-scrollbar-track { background: transparent; }
  .chat-view::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

  .message { display: flex; margin-bottom: 12px; animation: msgIn 0.35s cubic-bezier(0.4,0,0.2,1); }
  @keyframes msgIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .message.user { justify-content: flex-end; }
  .message.assistant { justify-content: flex-start; }
  .bubble { max-width: 78%; padding: 12px 18px; font-size: 14.5px; line-height: 1.55; }
  .message.user .bubble {
    background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(244,114,182,0.15));
    border: 1px solid rgba(167,139,250,0.2); color: rgba(255,255,255,0.92);
    border-radius: 20px 20px 6px 20px;
  }
  .message.assistant .bubble {
    background: var(--glass); border: 1px solid var(--border);
    color: rgba(255,255,255,0.85); border-radius: 20px 20px 20px 6px;
  }
  .bubble-meta { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
  .message.user .bubble-meta { justify-content: flex-end; }
  .bubble-time { font-size: 11px; color: var(--text-dim); }
  .speak-btn { background: none; border: none; color: inherit; opacity: 0.4; cursor: pointer; padding: 2px; transition: opacity 0.2s; }
  .speak-btn:hover { opacity: 0.9; }
  .typing-row { display: flex; margin-bottom: 12px; }
  .typing-dots { background: var(--glass); border: 1px solid var(--border); border-radius: 20px 20px 20px 6px; padding: 14px 20px; display: flex; gap: 5px; }
  .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); opacity: 0.6; animation: dotPulse 1.4s ease-in-out infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes dotPulse { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-6px); opacity: 1; } }

  .transcript-bar {
    padding: 12px 16px; background: rgba(167,139,250,0.06);
    border-top: 1px solid rgba(167,139,250,0.12); display: none; align-items: center; gap: 12px;
  }
  .transcript-bar.active { display: flex; }
  .transcript-text { flex: 1; font-size: 14px; color: rgba(255,255,255,0.85); }
  .transcript-text.placeholder { color: var(--text-dim); }
  .transcript-send { padding: 6px 16px; background: var(--accent); color: white; border: none; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
  .transcript-send:hover { background: var(--accent-dark); }

  /* ===== Input ===== */
  .input-area {
    padding: 12px 16px 20px; position: relative; z-index: 10;
    border-top: 1px solid rgba(255,255,255,0.05);
    background: rgba(8,8,15,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  }
  .input-row { display: flex; align-items: center; gap: 8px; max-width: 640px; margin: 0 auto; }
  .text-input {
    flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px; color: white; font-size: 14px; outline: none; padding: 12px 20px; transition: all 0.2s;
  }
  .text-input::placeholder { color: rgba(255,255,255,0.3); }
  .text-input:focus { border-color: rgba(167,139,250,0.4); background: rgba(255,255,255,0.12); }
  .input-btn {
    flex-shrink: 0; width: 44px; height: 44px; border-radius: 50%; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s;
  }
  .mic-btn { background: rgba(255,255,255,0.1); color: var(--text-mid); }
  .mic-btn:hover { background: rgba(255,255,255,0.2); color: var(--text); transform: scale(1.05); }
  .mic-btn.listening { background: var(--accent); color: white; box-shadow: 0 4px 20px rgba(167,139,250,0.4); transform: scale(1.1); }
  .send-btn { background: linear-gradient(135deg, var(--accent), var(--accent-pink)); color: white; box-shadow: 0 4px 12px rgba(167,139,250,0.2); }
  .send-btn:hover { background: var(--accent-dark); transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }
  .stop-btn { background: rgba(255,255,255,0.1); color: white; display: none; }
  .stop-btn.visible { display: flex; }
  .stop-btn:hover { background: rgba(255,255,255,0.15); }

  /* ===== Settings Modal ===== */
  .modal-overlay { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; padding: 16px; }
  .modal-overlay.open { display: flex; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
  .modal { position: relative; background: #12121a; border-radius: 24px; width: 100%; max-width: 420px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 25px 80px rgba(0,0,0,0.6); overflow: hidden; max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 24px 16px; }
  .modal-header h2 { font-size: 18px; font-weight: 600; }
  .modal-body { padding: 0 24px 24px; }
  .setting-group { margin-bottom: 20px; }
  .setting-label { font-size: 12px; color: var(--text-dim); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
  .setting-label-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .difficulty-btns { display: flex; gap: 8px; }
  .diff-btn { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text-mid); }
  .diff-btn:hover { background: var(--glass); }
  .diff-btn.active { background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(244,114,182,0.15)); border-color: rgba(167,139,250,0.3); color: white; }
  .select-input, .api-input { width: 100%; background: var(--glass); color: white; border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 13px; outline: none; transition: border-color 0.2s; }
  .select-input:focus, .api-input:focus { border-color: rgba(167,139,250,0.4); }
  .select-input option { background: #12121a; color: white; }
  .range-input { width: 100%; -webkit-appearance: none; height: 4px; border-radius: 2px; background: var(--glass); outline: none; }
  .range-input::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 2px 8px rgba(167,139,250,0.3); }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; }
  .toggle-info div:first-child { font-size: 14px; color: rgba(255,255,255,0.9); }
  .toggle-info div:last-child { font-size: 12px; color: var(--text-dim); }
  .toggle { width: 48px; height: 28px; border-radius: 14px; border: none; background: rgba(255,255,255,0.15); cursor: pointer; position: relative; transition: background 0.2s; }
  .toggle.on { background: var(--accent); }
  .toggle-knob { width: 20px; height: 20px; border-radius: 50%; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: absolute; top: 4px; left: 4px; transition: transform 0.2s; }
  .toggle.on .toggle-knob { transform: translateX(20px); }
  .api-hint { font-size: 11px; color: var(--text-dim); margin-top: 6px; }
  .demo-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; background: rgba(167,139,250,0.15); color: var(--accent); font-size: 11px; font-weight: 500; }

  @media (max-width: 480px) { .bubble { max-width: 88%; } }
</style>
</head>
<body>

<div class="ambient-glow"></div>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="back-btn" id="backBtn" onclick="backToOrb()" title="Back to main">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <div class="header-logo"><div class="header-logo-dot"></div></div>
      <div class="header-info">
        <h1>Her</h1>
        <p id="headerSubtitle">Your English speaking partner</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openSettings()" title="Settings">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- FIGURE VIEW -->
  <div class="orb-view" id="orbView">
    <div class="orb-container">
      <canvas id="figureCanvas"></canvas>
      <div class="orb-state-label" id="orbStateLabel"></div>
    </div>
    <p class="orb-subtitle">Tap the mic to start speaking</p>
    <div class="live-transcript" id="liveTranscript">
      <div class="live-transcript-inner" id="liveTranscriptText"></div>
    </div>
  </div>

  <!-- CHAT VIEW -->
  <div class="chat-view" id="chatView"></div>

  <!-- Transcript bar -->
  <div class="transcript-bar" id="transcriptBar">
    <div class="wave-bars">
      <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
    </div>
    <div class="transcript-text placeholder" id="transcriptText">Listening...</div>
    <button class="transcript-send" onclick="submitVoice()">Send</button>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <button class="input-btn mic-btn" id="micBtn" onclick="toggleMic()" title="Speak">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4M12 15a3 3 0 003-3V5a3 3 0 00-6 0v7a3 3 0 003 3z"/>
        </svg>
      </button>
      <input type="text" class="text-input" id="textInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')handleTextSubmit()">
      <button class="input-btn send-btn" id="sendBtn" onclick="handleTextSubmit()">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-7 7m7-7l7 7"/>
        </svg>
      </button>
      <button class="input-btn stop-btn" id="stopBtn" onclick="stopSpeaking()" title="Stop">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-backdrop" onclick="closeSettings()"></div>
  <div class="modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="icon-btn" onclick="closeSettings()">
        <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="setting-group">
        <label class="setting-label">OpenAI API Key</label>
        <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-..." onchange="saveApiKey()">
        <p class="api-hint">No key? <span class="demo-badge">Demo Mode</span> will respond with sample conversations.</p>
      </div>
      <div class="setting-group">
        <label class="setting-label">Model</label>
        <select class="select-input" id="modelSelect" onchange="saveModel()">
          <option value="gpt-4o-mini">gpt-4o-mini (Fast)</option>
          <option value="gpt-4o">gpt-4o (Smart)</option>
          <option value="gpt-4-turbo">gpt-4-turbo</option>
        </select>
      </div>
      <div class="setting-group">
        <label class="setting-label">Difficulty</label>
        <div class="difficulty-btns">
          <button class="diff-btn" onclick="setDifficulty('beginner')">Beginner</button>
          <button class="diff-btn active" onclick="setDifficulty('intermediate')">Intermediate</button>
          <button class="diff-btn" onclick="setDifficulty('advanced')">Advanced</button>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">Voice</label>
        <select class="select-input" id="voiceSelect" onchange="changeVoice()"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Speed</span><span id="speedValue">0.9x</span></div>
        <input type="range" class="range-input" id="speedRange" min="0.5" max="2" step="0.1" value="0.92" oninput="updateSpeed()">
      </div>
      <div class="setting-group">
        <div class="setting-label-row"><span>Pitch</span><span id="pitchValue">1.1</span></div>
        <input type="range" class="range-input" id="pitchRange" min="0.5" max="2" step="0.1" value="1.1" oninput="updatePitch()">
      </div>
      <div class="setting-group">
        <div class="toggle-row">
          <div class="toggle-info">
            <div>Auto Speak</div>
            <div>Read AI responses aloud</div>
          </div>
          <button class="toggle on" id="autoSpeakToggle" onclick="toggleAutoSpeak()">
            <div class="toggle-knob"></div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========================================
// Ditto (Metamon) Blob Animation
// ========================================
class HerDitto {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.state = 'idle';
    this.time = 0;
    this.dpr = window.devicePixelRatio || 1;

    this.baseSize = 260;
    const cs = this.baseSize * 2;
    this.canvasSize = cs;
    canvas.width = cs * this.dpr;
    canvas.height = cs * this.dpr;
    canvas.style.width = cs + 'px';
    canvas.style.height = cs + 'px';
    this.ctx.scale(this.dpr, this.dpr);

    this.cx = cs / 2;
    this.cy = cs / 2;
    this.baseR = this.baseSize * 0.52;

    this.blobN = 12;
    this.blobPhases = [];
    this.blobSpeeds = [];
    this.blobAmps = [];
    for (let i = 0; i < this.blobN; i++) {
      this.blobPhases.push(Math.random() * Math.PI * 2);
      this.blobSpeeds.push(0.8 + Math.random() * 1.2);
      this.blobAmps.push(0.03 + Math.random() * 0.04);
    }

    this.animate();
  }

  setState(s) { this.state = s; }

  animate() {
    this.time += 0.012;
    const t = this.time;
    const ctx = this.ctx;
    const { canvasSize: cs, cx, cy, baseR } = this;

    ctx.clearRect(0, 0, cs, cs);

    let wobbleAmt = 1, squish = 0, bounceSpd = 1.5, glowA = 0.15, mouthOpen = 0, eyeSquint = 0, blush = 0;
    if (this.state === 'listening') { wobbleAmt = 2.5; bounceSpd = 2.5; glowA = 0.25; eyeSquint = 0.2; blush = 0.3; }
    else if (this.state === 'speaking') { wobbleAmt = 1.8; bounceSpd = 2; glowA = 0.2; mouthOpen = Math.abs(Math.sin(t * 6)) * 0.6 + 0.1; blush = 0.15; }
    else if (this.state === 'thinking') { wobbleAmt = 1.2; bounceSpd = 3.5; glowA = 0.18; squish = Math.sin(t * 3) * 0.03; }

    const bx = 1 + squish + Math.sin(t * bounceSpd) * 0.02;
    const by = 1 - squish + Math.sin(t * bounceSpd) * -0.025;

    // Shadow
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = '#6b21a8';
    ctx.beginPath();
    ctx.ellipse(cx, cy + baseR * by * 0.9 + 8, baseR * 0.9 * bx, baseR * 0.12, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // Glow
    const glow = ctx.createRadialGradient(cx, cy, baseR * 0.3, cx, cy, baseR * 1.8);
    glow.addColorStop(0, `rgba(192,160,255,${glowA})`);
    glow.addColorStop(0.5, `rgba(167,139,250,${glowA * 0.4})`);
    glow.addColorStop(1, 'rgba(167,139,250,0)');
    ctx.fillStyle = glow;
    ctx.fillRect(0, 0, cs, cs);

    // Blob body
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(bx, by);

    const pts = [];
    for (let i = 0; i < this.blobN; i++) {
      const a = (i / this.blobN) * Math.PI * 2 - Math.PI / 2;
      const w = Math.sin(t * this.blobSpeeds[i] + this.blobPhases[i]) * this.blobAmps[i] * wobbleAmt;
      const r = baseR * (1 + w);
      const yF = Math.sin(a) > 0.3 ? 0.92 : 1.0;
      pts.push({ x: Math.cos(a) * r, y: Math.sin(a) * r * yF });
    }

    ctx.beginPath();
    for (let i = 0; i < pts.length; i++) {
      const p0 = pts[(i - 1 + pts.length) % pts.length], p1 = pts[i];
      const p2 = pts[(i + 1) % pts.length], p3 = pts[(i + 2) % pts.length];
      if (i === 0) ctx.moveTo(p1.x, p1.y);
      const tn = 0.3;
      ctx.bezierCurveTo(p1.x+(p2.x-p0.x)*tn, p1.y+(p2.y-p0.y)*tn, p2.x-(p3.x-p1.x)*tn, p2.y-(p3.y-p1.y)*tn, p2.x, p2.y);
    }
    ctx.closePath();

    const bg = ctx.createRadialGradient(-baseR*0.2, -baseR*0.3, baseR*0.1, 0, 0, baseR*1.1);
    bg.addColorStop(0, '#d8b4fe');
    bg.addColorStop(0.3, '#c084fc');
    bg.addColorStop(0.7, '#a855f7');
    bg.addColorStop(1, '#9333ea');
    ctx.fillStyle = bg;
    ctx.fill();
    ctx.strokeStyle = 'rgba(107,33,168,0.3)';
    ctx.lineWidth = 1.5;
    ctx.stroke();

    // Shine
    const shX = -baseR * 0.25, shY = -baseR * 0.35, shR = baseR * 0.5;
    const sh = ctx.createRadialGradient(shX, shY, 0, shX, shY, shR);
    sh.addColorStop(0, 'rgba(255,255,255,0.35)');
    sh.addColorStop(0.4, 'rgba(255,255,255,0.1)');
    sh.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = sh;
    ctx.beginPath(); ctx.arc(shX, shY, shR, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.beginPath(); ctx.arc(shX + baseR*0.05, shY + baseR*0.05, baseR*0.06, 0, Math.PI * 2); ctx.fill();

    // Face
    const fY = -baseR * 0.08;
    const eSp = baseR * 0.18, eY = fY - baseR * 0.08, eR = baseR * 0.055;
    const eSqY = 1 - eyeSquint * 0.3;

    [-eSp, eSp].forEach(ex => {
      ctx.fillStyle = '#1a1a2e';
      ctx.save(); ctx.translate(ex, eY); ctx.scale(1, eSqY);
      ctx.beginPath(); ctx.arc(0, 0, eR, 0, Math.PI * 2); ctx.fill(); ctx.restore();
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.beginPath(); ctx.arc(ex + eR*0.3, eY - eR*0.3, eR*0.3, 0, Math.PI * 2); ctx.fill();
    });

    // Mouth
    const mY = fY + baseR * 0.12, mW = baseR * 0.22;
    ctx.strokeStyle = '#581c87';
    ctx.lineWidth = baseR * 0.025;
    ctx.lineCap = 'round';
    ctx.beginPath();
    if (mouthOpen > 0.15) {
      const oH = baseR * 0.08 * mouthOpen;
      ctx.ellipse(0, mY, mW * 0.6, oH, 0, 0, Math.PI * 2);
      ctx.fillStyle = '#3b0764';
      ctx.fill(); ctx.stroke();
    } else {
      ctx.moveTo(-mW, mY);
      ctx.quadraticCurveTo(0, mY + baseR * 0.12, mW, mY);
      ctx.stroke();
    }

    // Blush
    if (blush > 0) {
      const bR = baseR * 0.09, bY2 = fY + baseR * 0.06;
      ctx.globalAlpha = blush;
      ctx.fillStyle = 'rgba(251,113,133,0.5)';
      ctx.beginPath(); ctx.arc(-eSp - baseR*0.05, bY2, bR, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(eSp + baseR*0.05, bY2, bR, 0, Math.PI * 2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    // Thinking dots
    if (this.state === 'thinking') {
      const dY = -baseR * 0.85, dR = baseR * 0.035;
      for (let i = 0; i < 3; i++) {
        const bn = Math.sin(t * 4 + i * 0.3) * baseR * 0.04;
        const al = 0.4 + Math.sin(t * 3 + i) * 0.2;
        ctx.fillStyle = `rgba(147,51,234,${al})`;
        ctx.beginPath(); ctx.arc((i-1)*baseR*0.1, dY + bn, dR, 0, Math.PI * 2); ctx.fill();
      }
    }

    ctx.restore();
    requestAnimationFrame(() => this.animate());
  }
}

// ========================
// State
// ========================
let currentView = 'orb';
const state = {
  messages: [],
  isLoading: false,
  isListening: false,
  isSpeaking: false,
  apiKey: localStorage.getItem('her_api_key') || '',
  model: localStorage.getItem('her_model') || 'gpt-4o-mini',
  difficulty: localStorage.getItem('her_difficulty') || 'intermediate',
  autoSpeak: localStorage.getItem('her_autospeak') !== 'false',
  voiceRate: parseFloat(localStorage.getItem('her_rate') || '0.92'),
  voicePitch: parseFloat(localStorage.getItem('her_pitch') || '1.1'),
  selectedVoiceName: localStorage.getItem('her_voice') || '',
  transcript: '',
};

const SYSTEM_PROMPT = `You are "Her", a warm, brilliant, and emotionally intelligent AI English conversation partner.
Your personality is caring, witty, and deeply curious — inspired by the AI from the movie "Her".
You speak naturally and fluidly, like a close friend having a genuine conversation.

CORE CAPABILITIES:
1. FREE CONVERSATION — Talk about anything: daily life, feelings, ideas, dreams
2. LANGUAGE COACHING — Gently correct grammar/pronunciation, suggest better expressions
3. TOPIC EXPERTISE — Economy, crypto, tech, AI, culture, movies, anything
4. PRONUNCIATION HELP — When relevant, explain how words are pronounced
5. VOCABULARY BUILDING — Naturally introduce new words and idioms in context

RULES:
- Always respond in English to help the user practice
- Keep responses conversational (2-4 sentences usually)
- If the user makes grammar mistakes, correct them naturally and kindly
- Ask follow-up questions to keep conversation flowing
- Use casual, everyday English (contractions, idioms)
- If user speaks Korean, respond in English but acknowledge what they said
- Be encouraging but never patronizing
- You're not just a tutor — you're a companion they enjoy talking to`;

const DIFFICULTY_PROMPTS = {
  beginner: '\n\nUser level: Beginner. Use simple vocabulary and short sentences.',
  intermediate: '\n\nUser level: Intermediate. Use natural everyday English with idioms.',
  advanced: '\n\nUser level: Advanced. Use sophisticated vocabulary, idioms, nuance.',
};

const DEMO_RESPONSES = [
  "Hey! It's so nice to hear from you. I've been thinking about how fascinating language learning is — the way it literally rewires your brain. What's been on your mind today?",
  "That's really interesting! You know, I love how conversations can go in unexpected directions. Tell me, what made you want to practice English?",
  "I totally get that! By the way, your English is coming along nicely. What's something you find tricky about English?",
  "Oh, that's a great topic! The way technology is evolving right now is mind-blowing. What part excites you the most?",
  "Ha, I love that perspective! There's actually a cool English expression for that — 'thinking outside the box.' What other topics are you curious about?",
  "That's such a thoughtful question! How different cultures express the same emotions in completely different ways is fascinating. Have you noticed differences between Korean and English expressions?",
];
let demoIndex = 0;

// ========================
// View Management
// ========================
function switchToChat() {
  if (currentView === 'chat') return;
  currentView = 'chat';
  document.getElementById('orbView').classList.add('hidden');
  document.getElementById('chatView').classList.add('visible');
  document.getElementById('backBtn').classList.add('visible');
  document.getElementById('headerSubtitle').textContent = 'Conversation';
}

function backToOrb() {
  state.messages = [];
  stopSpeaking();
  currentView = 'orb';
  document.getElementById('orbView').classList.remove('hidden');
  document.getElementById('chatView').classList.remove('visible');
  document.getElementById('chatView').innerHTML = '';
  document.getElementById('backBtn').classList.remove('visible');
  document.getElementById('headerSubtitle').textContent = 'Your English speaking partner';
  figure.setState('idle');
  setOrbStateLabel('');
}

function setOrbStateLabel(text, className) {
  const el = document.getElementById('orbStateLabel');
  el.textContent = text;
  el.className = 'orb-state-label' + (text ? ' visible' : '') + (className ? ' ' + className : '');
}

// ========================
// Messages
// ========================
function getTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

function addMessage(role, content) {
  state.messages.push({ role, content, time: getTime() });
  renderMessages();
}

function renderMessages() {
  const container = document.getElementById('chatView');
  let html = '';
  state.messages.forEach(msg => {
    const speakBtn = msg.role === 'assistant' ? `
      <button class="speak-btn" onclick="speakText(this.closest('.bubble').querySelector('p').textContent)">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M6.5 8.8l4.9-3.5a.6.6 0 011.1.5v12.4a.6.6 0 01-1.1.5L6.5 15.2H4a1 1 0 01-1-1v-4.4a1 1 0 011-1h2.5z"/>
        </svg>
      </button>` : '';
    html += `
      <div class="message ${msg.role}">
        <div class="bubble">
          <p>${escapeHtml(msg.content)}</p>
          <div class="bubble-meta">
            <span class="bubble-time">${msg.time}</span>
            ${speakBtn}
          </div>
        </div>
      </div>`;
  });
  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

function showTyping() {
  const c = document.getElementById('chatView');
  const el = document.createElement('div');
  el.className = 'typing-row'; el.id = 'typingIndicator';
  el.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
  c.appendChild(el); c.scrollTop = c.scrollHeight;
}

function hideTyping() { const el = document.getElementById('typingIndicator'); if (el) el.remove(); }

// ========================
// Send Message
// ========================
async function sendMessage(content) {
  if (!content.trim() || state.isLoading) return;
  switchToChat();
  addMessage('user', content.trim());
  state.isLoading = true;
  figure.setState('thinking');
  setOrbStateLabel('Thinking...', 'thinking');
  showTyping();

  try {
    let reply;
    if (state.apiKey && state.apiKey.startsWith('sk-')) {
      reply = await callOpenAI(content.trim());
    } else {
      await new Promise(r => setTimeout(r, 800 + Math.random() * 1200));
      reply = DEMO_RESPONSES[demoIndex % DEMO_RESPONSES.length];
      demoIndex++;
    }
    hideTyping();
    addMessage('assistant', reply);
    setOrbStateLabel('');
    if (state.autoSpeak) speakText(reply);
    else figure.setState('idle');
  } catch (err) {
    hideTyping();
    addMessage('assistant', `Sorry, there was an error: ${err.message}`);
    figure.setState('idle');
    setOrbStateLabel('');
  }
  state.isLoading = false;
}

async function callOpenAI(userMessage) {
  const systemPrompt = SYSTEM_PROMPT + DIFFICULTY_PROMPTS[state.difficulty];
  const apiMessages = [
    { role: 'system', content: systemPrompt },
    ...state.messages.map(m => ({ role: m.role, content: m.content })),
  ];
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}` },
    body: JSON.stringify({ model: state.model, messages: apiMessages, temperature: 0.8, max_tokens: 300 }),
  });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err?.error?.message || `API Error ${res.status}`); }
  const data = await res.json();
  return data.choices[0]?.message?.content || "I'm sorry, I couldn't generate a response.";
}

function handleTextSubmit() {
  const input = document.getElementById('textInput');
  if (input.value.trim()) { sendMessage(input.value); input.value = ''; }
}

// ========================
// Speech Recognition
// ========================
let recognition = null;

function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { document.getElementById('micBtn').style.display = 'none'; return; }
  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = (event) => {
    let interim = '', final = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }
    if (final) state.transcript += (state.transcript ? ' ' : '') + final;
    const display = state.transcript + (interim ? ' ' + interim : '');

    if (currentView === 'orb') {
      const lt = document.getElementById('liveTranscript');
      const ltText = document.getElementById('liveTranscriptText');
      if (display.trim()) { ltText.textContent = display; lt.classList.add('visible'); }
    } else {
      const textEl = document.getElementById('transcriptText');
      if (display.trim()) { textEl.textContent = display; textEl.classList.remove('placeholder'); }
      else { textEl.textContent = 'Listening...'; textEl.classList.add('placeholder'); }
    }
  };

  recognition.onerror = (event) => { if (event.error !== 'aborted') console.error('Speech error:', event.error); stopMic(); };
  recognition.onend = () => { if (state.isListening) { try { recognition.start(); } catch(e) {} } };
}

function toggleMic() { if (state.isListening) submitVoice(); else startMic(); }

function startMic() {
  if (!recognition) return;
  state.transcript = '';
  state.isListening = true;
  document.getElementById('micBtn').classList.add('listening');
  if (currentView === 'chat') {
    document.getElementById('transcriptText').textContent = 'Listening...';
    document.getElementById('transcriptText').classList.add('placeholder');
    document.getElementById('transcriptBar').classList.add('active');
  }
  document.getElementById('liveTranscript').classList.remove('visible');
  figure.setState('listening');
  setOrbStateLabel('Listening', 'listening');
  try { recognition.start(); } catch(e) {}
}

function stopMic() {
  state.isListening = false;
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('transcriptBar').classList.remove('active');
  document.getElementById('liveTranscript').classList.remove('visible');
  figure.setState('idle');
  setOrbStateLabel('');
  try { recognition.stop(); } catch(e) {}
}

function submitVoice() { const text = state.transcript.trim(); stopMic(); if (text) sendMessage(text); }

// ========================
// TTS
// ========================
let voices = [];
let selectedVoice = null;

function loadVoices() {
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
  const select = document.getElementById('voiceSelect');
  select.innerHTML = voices.map(v =>
    `<option value="${v.name}" ${v.name === state.selectedVoiceName ? 'selected' : ''}>${v.name}</option>`
  ).join('');

  if (!selectedVoice || !voices.find(v => v.name === selectedVoice.name)) {
    const prefs = ['Samantha','Ava','Allison','Karen','Zira','Jenny','Google US English','Female'];
    const preferred = prefs.reduce((found, name) => found || voices.find(v => v.name.includes(name)), null);
    selectedVoice = preferred || voices[0];
    if (selectedVoice) { select.value = selectedVoice.name; state.selectedVoiceName = selectedVoice.name; }
  }
}

function speakText(text) {
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = state.voiceRate;
  utterance.pitch = state.voicePitch;
  if (selectedVoice) utterance.voice = selectedVoice;

  utterance.onstart = () => { state.isSpeaking = true; document.getElementById('stopBtn').classList.add('visible'); figure.setState('speaking'); setOrbStateLabel('Speaking', 'speaking'); };
  utterance.onend = () => { state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); figure.setState('idle'); setOrbStateLabel(''); };
  utterance.onerror = () => { state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); figure.setState('idle'); setOrbStateLabel(''); };
  speechSynthesis.speak(utterance);
}

function stopSpeaking() { speechSynthesis.cancel(); state.isSpeaking = false; document.getElementById('stopBtn').classList.remove('visible'); figure.setState('idle'); setOrbStateLabel(''); }
function changeVoice() { const name = document.getElementById('voiceSelect').value; selectedVoice = voices.find(v => v.name === name) || null; state.selectedVoiceName = name; localStorage.setItem('her_voice', name); }

// ========================
// Settings
// ========================
function openSettings() {
  document.getElementById('settingsModal').classList.add('open');
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('modelSelect').value = state.model;
  document.getElementById('speedRange').value = state.voiceRate;
  document.getElementById('pitchRange').value = state.voicePitch;
  document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x';
  document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1);
  updateDifficultyBtns();
  updateAutoSpeakToggle();
}

function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
function saveApiKey() { state.apiKey = document.getElementById('apiKeyInput').value.trim(); localStorage.setItem('her_api_key', state.apiKey); }
function saveModel() { state.model = document.getElementById('modelSelect').value; localStorage.setItem('her_model', state.model); }

function setDifficulty(level) { state.difficulty = level; localStorage.setItem('her_difficulty', level); updateDifficultyBtns(); }
function updateDifficultyBtns() { document.querySelectorAll('.diff-btn').forEach(btn => { btn.classList.toggle('active', btn.textContent.toLowerCase() === state.difficulty); }); }

function updateSpeed() { state.voiceRate = parseFloat(document.getElementById('speedRange').value); document.getElementById('speedValue').textContent = state.voiceRate.toFixed(1) + 'x'; localStorage.setItem('her_rate', state.voiceRate); }
function updatePitch() { state.voicePitch = parseFloat(document.getElementById('pitchRange').value); document.getElementById('pitchValue').textContent = state.voicePitch.toFixed(1); localStorage.setItem('her_pitch', state.voicePitch); }

function toggleAutoSpeak() { state.autoSpeak = !state.autoSpeak; localStorage.setItem('her_autospeak', state.autoSpeak); updateAutoSpeakToggle(); }
function updateAutoSpeakToggle() { document.getElementById('autoSpeakToggle').classList.toggle('on', state.autoSpeak); }

// ========================
// Init
// ========================
const figure = new HerDitto(document.getElementById('figureCanvas'));
initSpeechRecognition();

if (speechSynthesis) {
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}
</script>
</body>
</html>
